@{
    Layout = null;
}


<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>设计流程</title>
    <!--框架必需start-->
    <link href="/Assets/gooflow/learunui-framework.css" rel="stylesheet" />
    <script src="/Assets/gooflow/jquery-1.8.2.min.js"></script>
    <script src="/Assets/gooflow/learunui-framework.js"></script>
    <!--框架必需end-->
    <!--流程设计器start-->
    <link  href="/Assets/gooflow/GooFlow.css" rel="stylesheet" />
    <script src="/Assets/gooflow/GooFlow.js"></script>
    <!--流程设计器end-->
    <!--Jquery打印 start-->
    <script src="/Assets/gooflow/jquery.jqprint-0.3.js"></script>
    <!--Jquery打印 end-->
    <script type="text/javascript">
        var KeyValue = GetQuery('KeyValue');//主键
        $(document).ready(function () {
            document.onselectstart = function () { return false; };
            LoadGooFlow();
        });
        //初始化设计流程器
        var FlowPanel;
        function LoadGooFlow() {
            FlowPanel = $.createGooFlow($("#FlowPanel"), {
                width: top.$('body').width() - 40 - 2,
                height: top.$('body').height() - 100 - 45,
                haveHead: true,
                headBtns: ["undo", "redo"],
                haveTool: true,
                toolBtns: ["startround", "endround", "stepnode", "shuntnode", "confluencenode"],
                haveGroup: true,
                useOperStack: true
            });
            FlowPanel.setNodeRemarks({
                cursor: "选择指针",
                direct: "步骤连线",
                startround: "开始节点",
                endround: "结束节点",
                stepnode: "普通节点",
                shuntnode: "分流节点",
                confluencenode: "合流节点",
                group: "区域规划"
            });
            //获取流程
            AjaxJson("/WorkflowModule/FlowDesign/SetFlowLayout", { FlowMainId: KeyValue }, function (data) {
                var FlowJson = JSON.parse(data.FlowJson);
                if (FlowJson) {
                    FlowPanel.loadData(FlowJson);
                    var FlowNodePermissionJson = data.FlowNodePermissionJson;
                    var FlowNodeButtonJson = data.FlowNodeButtonJson;
                    var FlowNodeJson = data.FlowNodeJson;
                    $.each(FlowNodeJson, function (i) {
                        var FlowNodeId = FlowNodeJson[i].FlowNodeId;
                        var FlowNodeCode = FlowNodeJson[i].FlowNodeCode;
                        //节点信息
                        var RowJson = FlowNodeJson[i];

                        //获取节点人员权限
                        var role_Permission = [];
                        var department_Permission = [];
                        var post_Permission = [];
                        var usergroup_Permission = [];
                        var user_Permission = [];
                        $.each(FlowNodePermissionJson, function (j) {
                            if (FlowNodePermissionJson[j].FlowNodeId == FlowNodeId && FlowNodePermissionJson[j].ObjectType == '1') {
                                role_Permission.push(FlowNodePermissionJson[j].ObjectId)
                            }
                            if (FlowNodePermissionJson[j].FlowNodeId == FlowNodeId && FlowNodePermissionJson[j].ObjectType == '2') {
                                department_Permission.push(FlowNodePermissionJson[j].ObjectId)
                            }
                            if (FlowNodePermissionJson[j].FlowNodeId == FlowNodeId && FlowNodePermissionJson[j].ObjectType == '3') {
                                post_Permission.push(FlowNodePermissionJson[j].ObjectId)
                            }
                            if (FlowNodePermissionJson[j].FlowNodeId == FlowNodeId && FlowNodePermissionJson[j].ObjectType == '4') {
                                usergroup_Permission.push(FlowNodePermissionJson[j].ObjectId)
                            }
                            if (FlowNodePermissionJson[j].FlowNodeId == FlowNodeId && FlowNodePermissionJson[j].ObjectType == '5') {
                                user_Permission.push(FlowNodePermissionJson[j].ObjectId)
                            }
                        });
                        RowJson["role_Permission"] = String(role_Permission);
                        RowJson["department_Permission"] = String(department_Permission);
                        RowJson["post_Permission"] = String(post_Permission);
                        RowJson["usergroup_Permission"] = String(usergroup_Permission);
                        RowJson["user_Permission"] = String(user_Permission);

                        //获取节点按钮权限
                        var button_Permission = [];
                        $.each(FlowNodeButtonJson, function (k) {
                            if (FlowNodeButtonJson[k].FlowNodeId == FlowNodeId) {
                                var rowdata = {
                                    ButtonId: FlowNodeButtonJson[k].ButtonId,
                                    IsBack: FlowNodeButtonJson[k].IsBack,
                                }
                                button_Permission.push(rowdata)
                            }
                        });
                        RowJson["button_Permission"] = button_Permission;

                        NodeInfoJson[FlowNodeCode] = RowJson;
                    });

                    var FlowLineJson = data.FlowLineJson;
                    $.each(FlowLineJson, function (i) {
                        var FlowLineId = FlowLineJson[i].FlowLineId;
                        var FlowLineCode = FlowLineJson[i].FlowLineCode;
                        var RowJson = FlowLineJson[i];
                        LineInfoJson[FlowLineCode] = RowJson;
                    });
                }
            });
            //保持流程
            $("#save").click(function () {
                var IsCheckData = true;
                if (!IsCheckData) {
                    return false;
                }
                Loading(true, "正在提交数据...");
                window.setTimeout(function () {
                    var postData = {
                        FlowMainId: KeyValue,
                        FlowJson: JSON.stringify(FlowPanel.exportData()),
                        NodeInfoJson: JSON.stringify(NodeInfoJson),
                        LineInfoJson: JSON.stringify(LineInfoJson),
                    }
                    AjaxJson("/WorkflowModule/FlowDesign/SaveFlowLayout", postData, function (data) {
                        tipDialog(data.Message, 3, data.Code);
                        top.frames[tabiframeId()].windowload();
                        //closeDialog();
                    });
                }, 200);
            })
        }
        //节点设置
        var NodeInfoJson = {};
        function OpenNode(This) {
            var _nodeData = This.$nodeData[$('.item_focus').attr('id')];
            var NodeNo = $('.item_focus').attr('id');
            var NodeName = _nodeData.name;
            var url = "/WorkflowModule/FlowDesign/FlowNode?NodeNo=" + NodeNo + "&NodeName=" + escape(NodeName) + "&NodeType=" + _nodeData.type;
            openDialog(url, "FlowNode", "节点设置【" + NodeName + "】", 650, 330, function (iframe) {
                top.frames[iframe].AcceptClick(function (data) {
                    NodeInfoJson[NodeNo] = data;
                    $(".item_focus table tr:eq(0) td:eq(1)").text(data.FlowStep);
                    This.setName(NodeNo, data.FlowStep, "node");
                })
            });
        };
        //流转线设置
        var LineInfoJson = {}; 
        function OpenLine(id, This) {
            var NodeId = JSON.stringify(FlowPanel.exportData().lines[id].from).replace(/"/g, '');
            if (NodeInfoJson[NodeId]) {
                var FrmType = NodeInfoJson[NodeId].FrmType;
                var BindTable = NodeInfoJson[NodeId].BindTable;
                var LineNo = id;
                var LineName = $("#" + id + " text").text();
                var url = "/WorkflowModule/FlowDesign/FlowLineCondition?LineNo=" + LineNo + "&LineName=" + escape(LineName) + "&BindTable=" + escape(BindTable);
                openDialog(url, "FlowLineCondition", "流转条件设置", 650, 350, function (iframe) {
                    top.frames[iframe].AcceptClick(function (data) {
                        LineInfoJson[LineNo] = data;
                        $("#" + LineNo + " text").text(data.LineName);
                        This.setName(LineNo, data.LineName, "line");
                    })
                });
            } else {
                var name = JSON.stringify(FlowPanel.exportData().nodes[NodeId].name.replace(/"/g, ''));
                tipDialog('请完善【' + name + '】节点信息', 4, 'warning');
            }
        }
    </script>
</head>
<body>
    <div class="nui-toolbar leftline rightline" style="margin: 1px;">
        <div class="nui-toolbar-item" onclick="Replace()">
            <span class="nui-btn-text">刷新</span>
        </div>
        <div id="save" class="nui-toolbar-item">
            <span class="nui-btn-text">保存</span>
        </div>
        <div class="nui-toolbar-item nui-btn-right" onclick="$('.GooFlow_head_btn').find('.ico_undo').trigger('click')">
            <span class="nui-btn-text">撤销</span>
        </div>
        <div class="nui-toolbar-item nui-btn-left" onclick="$('.GooFlow_head_btn').find('.ico_redo').trigger('click')">
            <span class="nui-btn-text">重做</span>
        </div>
        <div style="position: absolute; float: right; top: 5px; right: 5px;">
        </div>
    </div>
    <div id="FlowPanel" style="margin: 1px; margin-top: 0px;"></div>
</body>
</html>
